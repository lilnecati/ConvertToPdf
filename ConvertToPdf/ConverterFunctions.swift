import SwiftUI
import PDFKit
import Cocoa
import AppKit
import Foundation
import QuickLookThumbnailing
import Quartz

// Dosya ve format d√∂n√º≈üt√ºrme fonksiyonlarƒ±
class FileConverter {
    
    // D√∂n√º≈ü√ºm tipleri
    enum ConversionType {
        case PDFToJPEG
        case PDFToJPG
        case PDFToPNG
        case PDFToPDF
        case ImageToPDF
        case OfficeToPDF
        case Unknown
    }
    
    // D√∂n√º≈ü√ºm tipini belirle
    static func determineConversionType(inputFormat: String, outputFormat: String) -> ConversionType {
        switch (inputFormat, outputFormat) {
        case ("pdf", "jpg"), ("pdf", "jpeg"):
            return .PDFToJPEG
        case ("pdf", "png"):
            return .PDFToPNG
        case ("pdf", "pdf"):
            return .PDFToPDF
        case ("jpg", "pdf"), ("jpeg", "pdf"), ("png", "pdf"):
            return .ImageToPDF
        case ("doc", "pdf"), ("docx", "pdf"), ("ppt", "pdf"), ("pptx", "pdf"), ("xls", "pdf"), ("xlsx", "pdf"):
            return .OfficeToPDF
        default:
            return .Unknown
        }
    }
    
    // PDF'yi JPG'ye d√∂n√º≈üt√ºrme i≈ülemi
    static func convertPDFToJPEG(pdfURL: URL, saveURL: URL, progressUpdate: @escaping (Double) -> Void, completion: @escaping (Bool, URL?) -> Void) {
        guard let pdfDocument = PDFDocument(url: pdfURL) else {
            completion(false, nil)
            return
        }
        
        let pageCount = pdfDocument.pageCount
        var successCount = 0
        
        // Kayƒ±t dizinini al
        let saveDirectory = saveURL.deletingLastPathComponent()
        let baseName = saveURL.deletingPathExtension().lastPathComponent
        
        for pageIndex in 0..<pageCount {
            guard let page = pdfDocument.page(at: pageIndex) else {
                continue
            }
            
            // Sayfanƒ±n boyutlarƒ±nƒ± al
            let pageRect = page.bounds(for: .mediaBox)
            let scale: CGFloat = 2.0 // √á√∂z√ºn√ºrl√ºk √ßarpanƒ±
            let size = CGSize(width: pageRect.width * scale, height: pageRect.height * scale)
            
            // Sayfayƒ± thumbnail olarak al
            let image = page.thumbnail(of: size, for: .mediaBox)
        
            // NSImage'yi JPEG'e d√∂n√º≈üt√ºrme i≈ülemi
            if let bitmapRep = NSBitmapImageRep(data: image.tiffRepresentation!) {
                guard let jpegData = bitmapRep.representation(using: .jpeg, properties: [.compressionFactor: 0.9]) else {
                    continue
                }
                
                // Her sayfa i√ßin yeni bir dosya adƒ± olu≈ütur
                let pageFileName = "\(baseName)_sayfa\(pageIndex + 1).jpg"
                let pageURL = saveDirectory.appendingPathComponent(pageFileName)
                
                do {
                    try jpegData.write(to: pageURL)
                    successCount += 1
                    progressUpdate(Double(successCount) / Double(pageCount))
                    print("‚úÖ Sayfa \(pageIndex + 1) kaydedildi")
                } catch {
                    print("‚ö†Ô∏è Sayfa \(pageIndex + 1) kaydedilirken hata")
                }
            }
        }
        
        if successCount > 0 {
            progressUpdate(1.0)
            print("‚úÖ \(successCount) sayfa ba≈üarƒ±yla JPEG olarak d√∂n√º≈üt√ºr√ºld√º")
            completion(true, saveDirectory)
        } else {
            completion(false, nil)
        }
    }
    
    // PDF'yi PNG'ye d√∂n√º≈üt√ºrme i≈ülemi
    static func convertPDFToPNG(pdfURL: URL, saveURL: URL, progressUpdate: @escaping (Double) -> Void, completion: @escaping (Bool, URL?) -> Void) {
        guard let pdfDocument = PDFDocument(url: pdfURL) else {
            completion(false, nil)
            return
        }
        
        let pageCount = pdfDocument.pageCount
        var successCount = 0
        
        // Kayƒ±t dizinini al
        let saveDirectory = saveURL.deletingLastPathComponent()
        let baseName = saveURL.deletingPathExtension().lastPathComponent
        
        for pageIndex in 0..<pageCount {
            guard let page = pdfDocument.page(at: pageIndex) else {
                continue
            }
            
            // Sayfanƒ±n boyutlarƒ±nƒ± al
            let pageRect = page.bounds(for: .mediaBox)
            let scale: CGFloat = 2.0 // √á√∂z√ºn√ºrl√ºk √ßarpanƒ±
            let size = CGSize(width: pageRect.width * scale, height: pageRect.height * scale)
            
            // Sayfayƒ± thumbnail olarak al
            let image = page.thumbnail(of: size, for: .mediaBox)
        
            // NSImage'yi PNG'ye d√∂n√º≈üt√ºrme i≈ülemi
            if let bitmapRep = NSBitmapImageRep(data: image.tiffRepresentation!) {
                guard let pngData = bitmapRep.representation(using: .png, properties: [:]) else {
                    continue
                }
                
                // Her sayfa i√ßin yeni bir dosya adƒ± olu≈ütur
                let pageFileName = "\(baseName)_sayfa\(pageIndex + 1).png"
                let pageURL = saveDirectory.appendingPathComponent(pageFileName)
                
                do {
                    try pngData.write(to: pageURL)
                    successCount += 1
                    progressUpdate(Double(successCount) / Double(pageCount))
                    print("‚úÖ Sayfa \(pageIndex + 1) kaydedildi")
                } catch {
                    print("‚ö†Ô∏è Sayfa \(pageIndex + 1) kaydedilirken hata")
                }
            }
        }
        
        if successCount > 0 {
            progressUpdate(1.0)
            print("‚úÖ \(successCount) sayfa ba≈üarƒ±yla PNG olarak d√∂n√º≈üt√ºr√ºld√º")
            completion(true, saveDirectory)
        } else {
            completion(false, nil)
        }
    }
    
    // PDF'yi PDF'ye d√∂n√º≈üt√ºrme i≈ülemi (kopyalama i≈ülemi)
    static func convertPDFToPDF(pdfURL: URL, saveURL: URL, completion: @escaping (Bool, URL?) -> Void) {
        guard let pdfDocument = PDFDocument(url: pdfURL) else {
            completion(false, nil)
            return
        }
        
        // PDF'i yeni konuma kaydet
        if pdfDocument.write(to: saveURL) {
            print("‚úÖ PDF dosyasƒ± ba≈üarƒ±yla kaydedildi")
            completion(true, saveURL)
        } else {
            completion(false, nil)
        }
    }
    
    // JPG veya PNG'yi PDF'ye d√∂n√º≈üt√ºrme i≈ülemi
    static func convertImageToPDF(imageURL: URL, saveURL: URL, completion: @escaping (Bool, URL?) -> Void) {
        guard let image = NSImage(contentsOf: imageURL) else {
            completion(false, nil)
            return
        }
        
        // PDF belgesi olu≈ütur
        let pdfDocument = PDFDocument()
        
        // G√∂r√ºnt√ºy√º PDF sayfasƒ±na d√∂n√º≈üt√ºr
        if let page = PDFPage(image: image) {
            // Sayfayƒ± PDF'e ekle
            pdfDocument.insert(page, at: 0)
            
            // PDF'i kaydet
            if pdfDocument.write(to: saveURL) {
                print("‚úÖ G√∂rsel PDF'ye ba≈üarƒ±yla d√∂n√º≈üt√ºr√ºld√º")
                completion(true, saveURL)
            } else {
                completion(false, nil)
            }
        } else {
            completion(false, nil)
        }
    }
    
    // LibreOffice ile dosyayƒ± d√∂n√º≈üt√ºr
    static func convertWithLibreOffice(fileURL: URL, saveURL: URL, completion: @escaping (Bool, URL?) -> Void) {
        let fileExtension = fileURL.pathExtension.lowercased()
        
        // Uygun dosya uzantƒ±larƒ±nƒ± kontrol et
        let officeExtensions = ["doc", "docx", "xls", "xlsx", "ppt", "pptx"]
        guard officeExtensions.contains(fileExtension) else {
            completion(false, nil)
            return
        }
        
        print("üîÑ D√∂n√º≈üt√ºrme i≈ülemi ba≈üladƒ±")
        print("üìÑ Kaynak: \(fileURL.lastPathComponent)")
        print("üì• Hedef: \(saveURL.lastPathComponent)")
        
        // Doƒürudan kullanƒ±cƒ±nƒ±n se√ßtiƒüi konuma d√∂n√º≈üt√ºr
        convertWithClassicLibreOffice(fileURL: fileURL, saveURL: saveURL) { success, resultURL in
            if success, let resultURL = resultURL {
                // Ba≈üarƒ±lƒ±, PDF dosyasƒ±nƒ± kontrol et
                if let pdfDocument = PDFDocument(url: resultURL) {
                    let pageCount = pdfDocument.pageCount
                    print("‚úÖ \(fileExtension.uppercased()) dosyasƒ± ba≈üarƒ±yla d√∂n√º≈üt√ºr√ºld√º (Sayfa sayƒ±sƒ±: \(pageCount))")
                    completion(true, resultURL)
                } else {
                    print("‚ö†Ô∏è PDF dosyasƒ± olu≈üturuldu ancak a√ßƒ±lamadƒ±")
                    completion(true, resultURL)
                }
            } else {
                print("‚ùå LibreOffice d√∂n√º≈üt√ºrme ba≈üarƒ±sƒ±z oldu")
                completion(false, nil)
            }
        }
    }
    
    // Alternatif LibreOffice √ßaƒüƒ±rma metodu
    private static func convertWithClassicLibreOffice(fileURL: URL, saveURL: URL, onComplete: @escaping (Bool, URL?) -> Void) {
        let officePath = "/Applications/LibreOffice.app/Contents/MacOS/soffice"
        let saveDirectory = saveURL.deletingLastPathComponent().path
        
        print("üîÑ D√∂n√º≈üt√ºrme i≈ülemi ba≈üladƒ±")
        print("üìÑ Kaynak: \(fileURL.lastPathComponent)")
        print("üì• Hedef: \(saveURL.lastPathComponent)")
        
        // LibreOffice script i√ßeriƒüi
        let scriptContent = """
        #!/bin/bash
        
        # Hata mesajlarƒ±nƒ± ve √ßƒ±ktƒ±yƒ± g√∂sterme
        exec 2>/dev/null
        
        # √ñnceki bir dosya varsa sil
        if [ -f "\(saveURL.path)" ]; then
            rm "\(saveURL.path)"
        fi
        
        # Dizin yoksa olu≈ütur
        mkdir -p "\(saveDirectory)"
        
        # LibreOffice'i doƒürudan hedef dosyaya d√∂n√º≈üt√ºr
        "\(officePath)" --headless --nologo --nofirststartwizard --norestore --convert-to pdf --outdir "\(saveDirectory)" "\(fileURL.path)"
        
        # √áƒ±kƒ±≈ü kodu
        EXIT_CODE=$?
        
        # Olu≈üturulan dosyayƒ± kontrol et
        if [ -f "\(saveURL.path)" ]; then
            # Dosya zaten istenen konumda olu≈üturuldu
            exit 0
        else
            # Dosya farklƒ± bir isimle olu≈üturulmu≈ü olabilir, ta≈üƒ±
            BASENAME=$(basename "\(fileURL.path)" | sed 's/\\.[^.]*$//')
            GENERATED_PDF="\(saveDirectory)/${BASENAME}.pdf"
            
            if [ -f "$GENERATED_PDF" ]; then
                mv "$GENERATED_PDF" "\(saveURL.path)"
                exit 0
            else
                # Hi√ßbir PDF olu≈üturulmadƒ±
                exit $EXIT_CODE
            fi
        fi
        """
        
        // Ge√ßici script dosyasƒ±nƒ± olu≈ütur
        let tempDir = FileManager.default.temporaryDirectory
        let scriptURL = tempDir.appendingPathComponent("libreoffice_convert.sh")
        
        do {
            try scriptContent.write(to: scriptURL, atomically: true, encoding: String.Encoding.utf8)
            try FileManager.default.setAttributes([.posixPermissions: 0o755], ofItemAtPath: scriptURL.path)
            
            // Script'i y√ºr√ºt
            let task = Process()
            task.executableURL = URL(fileURLWithPath: "/bin/bash")
            task.arguments = [scriptURL.path]
            
            let pipe = Pipe()
            task.standardOutput = pipe
            task.standardError = pipe
            
            try task.run()
            task.waitUntilExit()
            
            // √áƒ±ktƒ±yƒ± oku ama g√∂sterme
            let outputData = pipe.fileHandleForReading.readDataToEndOfFile()
            _ = String(data: outputData, encoding: .utf8)
            
            // Script √ßalƒ±≈ütƒ±rma ba≈üarƒ±lƒ± mƒ±?
            if task.terminationStatus == 0 {
                // Dosya hedef konumda var mƒ±?
                if FileManager.default.fileExists(atPath: saveURL.path) {
                    print("‚úÖ D√∂n√º≈üt√ºrme tamamlandƒ±")
                    onComplete(true, saveURL)
                } else {
                    print("‚ö†Ô∏è Hedef bulunamadƒ±, diƒüer PDF dosyalarƒ± kontrol ediliyor...")
                    // Dizindeki PDF dosyalarƒ±nƒ± kontrol et
                    if let filesInDir = try? FileManager.default.contentsOfDirectory(atPath: saveDirectory) {
                        let pdfFiles = filesInDir.filter { $0.hasSuffix(".pdf") }
                        if let firstPDF = pdfFiles.first {
                            let foundPDF = URL(fileURLWithPath: saveDirectory).appendingPathComponent(firstPDF)
                            do {
                                try FileManager.default.moveItem(at: foundPDF, to: saveURL)
                                print("‚úÖ PDF bulundu ve ta≈üƒ±ndƒ±")
                                onComplete(true, saveURL)
                            } catch {
                                print("‚ö†Ô∏è Dosya ta≈üƒ±ma hatasƒ±")
                                onComplete(true, foundPDF)
                            }
                            return
                        }
                    }
                    print("‚ùå PDF dosyasƒ± bulunamadƒ±")
                    onComplete(false, nil)
                }
            } else {
                print("‚ùå LibreOffice d√∂n√º≈üt√ºrme ba≈üarƒ±sƒ±z oldu")
                onComplete(false, nil)
            }
            
            // Ge√ßici script dosyasƒ±nƒ± temizle
            try? FileManager.default.removeItem(at: scriptURL)
            
        } catch {
            print("‚ùå Script olu≈üturulamadƒ±: \(error)")
            onComplete(false, nil)
        }
    }
}
